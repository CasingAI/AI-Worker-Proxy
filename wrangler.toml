name = "ai-worker-proxy"
main = "src/index.ts"
compatibility_date = "2024-01-01"
# 多账号时在非交互式部署需指定；可改为另一账号 id 或使用环境变量 CLOUDFLARE_ACCOUNT_ID
account_id = "23ec159df1a5831b2b2d48ec1a7073d4"

# Cloudflare dashboard logs (optional)
[observability]
[observability.logs]
enabled = true
head_sampling_rate = 1
invocation_logs = true
persist = false

# ====================================================================================
# EXAMPLE CONFIGURATION
# ====================================================================================
# This [vars] section contains example configuration.
# GitHub Actions will REPLACE it with real ROUTES_CONFIG from GitHub Variable.
# Secrets (PROXY_AUTH_TOKEN, API keys) are set in Cloudflare Dashboard manually.
# ====================================================================================

[vars]
# Model routing configuration 
ROUTES_CONFIG = '''
{
  "zhipu-flash-latest-high": {
    "displayName": "GLM 4.7 Flash X High",
    "description": "智谱提供的 30B 级 SOTA 模型，兼顾性能与效率的新选择。",
    "contextWindow": 200000,
    "maxOutputTokens": 16384,
    "providers": [
      {
        "provider": "openaiChat",
        "model": "glm-4.7-flash",
        "apiKeys": ["ZHIPU_KEY_1"],
        "endpoint": "https://api.z.ai/api/paas/v4/",
        "pricingCurrency": "cny",
        "inputPricePer1m": 0.5,
        "inputCachePricePer1m": 0.1,
        "outputPricePer1m": 3,
        "customParams": { "tool_stream": true }
      }
    ],
    "metadata": {
      "tier": "free",
      "reasoning_effort": "high"
    },
    "flags": []
  },
  "zhipu-flash-latest-xhigh": {
    "displayName": "GLM 4.7 Flash X Extra High",
    "description": "在高推理基础上附加严格步骤与不确定性披露，适合需要可追溯链条的场景。",
    "contextWindow": 200000,
    "maxOutputTokens": 16384,
    "providers": [
      {
        "provider": "openaiChat",
        "model": "glm-4.7-flash",
        "apiKeys": ["ZHIPU_KEY_1"],
        "endpoint": "https://api.z.ai/api/paas/v4/",
        "pricingCurrency": "cny",
        "inputPricePer1m": 0.5,
        "inputCachePricePer1m": 0.1,
        "outputPricePer1m": 3,
        "customParams": { "tool_stream": true }
      }
    ],
    "metadata": {
      "tier": "free",
      "reasoning_effort": "xhigh"
    },
    "flags": []
  },
    "zhipu-flash-latest-medium": {
    "displayName": "GLM 4.7 Flash X",
    "description": "智谱提供的 30B 级 SOTA 模型，兼顾性能与效率的新选择。",
    "contextWindow": 200000,
    "maxOutputTokens": 16384,
    "providers": [
      {
        "provider": "openaiChat",
        "model": "glm-4.7-flash",
        "apiKeys": ["ZHIPU_KEY_1"],
        "endpoint": "https://api.z.ai/api/paas/v4/",
        "pricingCurrency": "cny",
        "inputPricePer1m": 0.5,
        "inputCachePricePer1m": 0.1,
        "outputPricePer1m": 3,
        "customParams": { "tool_stream": true }
      }
    ],
    "metadata": {
      "tier": "free",
      "reasoning_effort": "medium"
    },
    "flags": []
  },
    "zhipu-flash-latest-low": {
    "displayName": "GLM 4.7 Flash X Low",
    "description": "智谱提供的 30B 级 SOTA 模型，兼顾性能与效率的新选择。",
    "contextWindow": 200000,
    "maxOutputTokens": 16384,
    "providers": [
      {
        "provider": "openaiChat",
        "model": "glm-4.7-flash",
        "apiKeys": ["ZHIPU_KEY_1"],
        "endpoint": "https://api.z.ai/api/paas/v4/",
        "pricingCurrency": "cny",
        "inputPricePer1m": 0.5,
        "inputCachePricePer1m": 0.1,
        "outputPricePer1m": 3,
        "customParams": { "tool_stream": true }
      }
    ],
    "metadata": {
      "tier": "free",
      "reasoning_effort": "low"
    },
    "flags": []
  },
  "glm-4.6v-flash": {
    "displayName": "GLM 4.6V Flash",
    "description": "智谱提供的 12B 多模态模型，视觉理解精度上达到同参数规模 SOTA",
    "contextWindow": 128000,
    "maxOutputTokens": 0,
    "providers": [
      {
        "provider": "openaiChat",
        "model": "glm-4.6v-flash",
        "apiKeys": ["ZHIPU_CN_KEY"],
        "endpoint": "https://open.bigmodel.cn/api/paas/v4",
        "pricingCurrency": "cny",
        "inputPricePer1m": 0.3,
        "inputCachePricePer1m": 0.03,
        "outputPricePer1m": 3,
        "customParams": { "tool_stream": true }
      }
    ],
    "metadata": {
      "tier": "free"
    },
    "flags": ["image"]
  }
}
'''
PROXY_AUTH_TOKEN = "testGiuyghi"
# Relay 白名单：JSON 数组字符串，仅允许 /relay?url= 转发到这些 host（可选）
# RELAY_ALLOWED_HOSTS = '["api.openai.com","api.anthropic.com","api.example.com"]'

# Secrets to set in Cloudflare Dashboard:
# - PROXY_AUTH_TOKEN
# - OPENAI_KEY_1, OPENAI_KEY_2
# - ZHIPU_KEY_1
